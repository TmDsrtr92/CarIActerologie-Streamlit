name: Deploy to Development

on:
  push:
    branches: [ development ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deployment'

env:
  PYTHON_VERSION: "3.12"

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment: development
    name: Deploy to Development Environment
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run pre-deployment tests
      run: |
        python -c "from infrastructure.config.settings import get_config; print('âœ… Config validation passed')"
        python -c "
        import streamlit as st
        from services.ai_service.llm_client import get_llm_client
        print('âœ… Core imports successful')
        "

    - name: Create deployment marker
      run: |
        echo "Development deployment at $(date)" >> deployment-log.txt
        echo "Commit: ${{ github.sha }}" >> deployment-log.txt
        echo "Branch: ${{ github.ref_name }}" >> deployment-log.txt
        echo "Triggered by: ${{ github.actor }}" >> deployment-log.txt
        
    - name: Notify deployment status
      run: |
        echo "ðŸš€ Development deployment triggered for commit ${{ github.sha }}"
        echo "ðŸ“± App will be available at: https://cariacterologie-dev.streamlit.app"
        echo "â±ï¸ Deployment typically takes 2-3 minutes"

    - name: Create release notes for dev
      run: |
        echo "## Development Deployment - $(date)" > dev-release-notes.md
        echo "" >> dev-release-notes.md
        echo "**Commit:** ${{ github.sha }}" >> dev-release-notes.md
        echo "**Branch:** ${{ github.ref_name }}" >> dev-release-notes.md
        echo "**Triggered by:** ${{ github.actor }}" >> dev-release-notes.md
        echo "" >> dev-release-notes.md
        echo "### Recent Changes:" >> dev-release-notes.md
        git log --oneline -n 5 >> dev-release-notes.md

    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v3
      with:
        name: dev-deployment-${{ github.sha }}
        path: |
          deployment-log.txt
          dev-release-notes.md